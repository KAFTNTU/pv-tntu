<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>AR Клавіатура (UA Edition)</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background-color: #000;
            font-family: 'Courier New', monospace;
        }

        #container {
            position: relative;
            width: 100vw;
            height: 100vh;
        }

        /* 1. ВІДЕО (Задній фон) */
        #webcam-video {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            transform: scaleX(-1); /* Дзеркальне відображення */
            z-index: 1;
        }

        /* 2. 3D СЦЕНА (Клавіатура) */
        #threejs-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none; /* Щоб не блокувало інтерфейс */
            z-index: 2;
        }

        /* 3. ПАНЕЛЬ ТЕКСТУ (Зверху) */
        #typing-area {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: 90%;
            max-width: 600px;
            background: rgba(0, 30, 50, 0.85); /* Темно-синій прозорий */
            border: 2px solid #00ffcc;
            border-radius: 12px;
            padding: 15px;
            z-index: 10;
            box-shadow: 0 0 25px rgba(0, 255, 204, 0.2);
            text-align: center;
        }

        #output-text {
            color: #00ffcc;
            font-family: sans-serif;
            font-size: 1.8rem;
            font-weight: bold;
            min-height: 2.2rem;
            line-height: 2.2rem;
            display: inline-block;
            white-space: pre-wrap;
        }

        /* Курсор, що блимає */
        #cursor {
            display: inline-block;
            width: 3px;
            height: 2rem;
            background-color: #00ffcc;
            animation: blink 1s step-end infinite;
            vertical-align: bottom;
            margin-left: 2px;
        }

        @keyframes blink { 50% { opacity: 0; } }

        #loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #00ffcc;
            background: rgba(0,0,0,0.8);
            padding: 20px;
            border-radius: 8px;
            z-index: 20;
            font-size: 1.2rem;
        }
    </style>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
</head>
<body>

<div id="container">
    <div id="loading">Ініціалізація системи...</div>
    
    <div id="typing-area">
        <span id="output-text"></span><span id="cursor"></span>
    </div>

    <video id="webcam-video" playsinline></video>
    <canvas id="threejs-canvas"></canvas>
</div>

<script>
    const videoElement = document.getElementById('webcam-video');
    const threeCanvas = document.getElementById('threejs-canvas');
    const outputText = document.getElementById('output-text');
    const loading = document.getElementById('loading');

    // === НАЛАШТУВАННЯ ===
    const PRESS_THRESHOLD = 0.25; // Оптимальна зона дотику
    const PRESS_COOLDOWN = 400;   // Затримка між натисканнями (мс)
    
    let typedString = "";

    // === 1. THREE.JS (СЦЕНА) ===
    const scene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 1000);
    camera.position.z = 5;

    const renderer = new THREE.WebGLRenderer({ 
        canvas: threeCanvas, 
        alpha: true,      // Прозорий фон
        antialias: true 
    });
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.setPixelRatio(window.devicePixelRatio);

    // Освітлення
    const light = new THREE.PointLight(0xffffff, 1.5);
    light.position.set(0, 5, 5);
    scene.add(light);
    scene.add(new THREE.AmbientLight(0x606060));

    // Група для клавіш
    const keyboardGroup = new THREE.Group();
    keyboardGroup.position.set(0, -1.0, 2); // Трохи нижче центру
    scene.add(keyboardGroup);

    const keysData = [];

    // === ДОПОМІЖНА ФУНКЦІЯ: Створення текстури з літерою ===
    // Це дозволяє використовувати УКРАЇНСЬКУ мову без зовнішніх шрифтів
    function createCharTexture(char) {
        const canvas = document.createElement('canvas');
        canvas.width = 128;
        canvas.height = 128;
        const ctx = canvas.getContext('2d');
        
        // Малюємо літеру
        ctx.fillStyle = 'white';
        ctx.font = 'bold 80px Arial, sans-serif'; // Стандартний шрифт браузера
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        
        let text = char;
        if (char === 'SPACE') text = '___';
        if (char === 'DEL') text = '←';

        ctx.fillText(text, 64, 64);
        
        const texture = new THREE.CanvasTexture(canvas);
        return texture;
    }

    // === ГЕНЕРАЦІЯ КЛАВІАТУРИ ===
    function createKeyboard() {
        const rows = [
            ['1','2','3','4','5','6','7','8','9','0','DEL'],
            ['Й','Ц','У','К','Е','Н','Г','Ш','Щ','З','Х'],
            ['Ф','І','В','А','П','Р','О','Л','Д','Ж','Є'],
            ['Я','Ч','С','М','И','Т','Ь','Б','Ю','SPACE']
        ];

        const keyWidth = 0.5;
        const keyHeight = 0.5;
        const spacing = 0.08;
        const keyGeometry = new THREE.BoxGeometry(keyWidth, keyHeight, 0.05);
        
        // Матеріал кнопки (напівпрозорий синій)
        const baseMaterial = new THREE.MeshPhongMaterial({ 
            color: 0x004466, 
            transparent: true, 
            opacity: 0.6,
            shininess: 100
        });
        
        // Матеріал натиснутої кнопки (яскраво-зелений)
        const pressedMaterial = new THREE.MeshPhongMaterial({ color: 0x00ff44, emissive: 0x004400 });

        rows.forEach((row, rowIndex) => {
            const rowWidth = row.length * (keyWidth + spacing);
            const startX = -rowWidth / 2 + keyWidth/2;
            const y = (rows.length - rowIndex) * (keyHeight + spacing) - 1.5;

            row.forEach((char, charIndex) => {
                const x = startX + charIndex * (keyWidth + spacing);

                // 1. Створюємо фізичну кнопку
                const keyMesh = new THREE.Mesh(keyGeometry, baseMaterial.clone());
                keyMesh.position.set(x, y, 0);
                keyboardGroup.add(keyMesh);

                // 2. Створюємо "наклейку" з літерою
                const labelGeo = new THREE.PlaneGeometry(keyWidth * 0.8, keyHeight * 0.8);
                const labelMat = new THREE.MeshBasicMaterial({ 
                    map: createCharTexture(char), 
                    transparent: true 
                });
                const labelMesh = new THREE.Mesh(labelGeo, labelMat);
                labelMesh.position.set(0, 0, 0.06); // Трохи вище кнопки
                keyMesh.add(labelMesh);

                // 3. Зберігаємо дані для логіки
                keysData.push({
                    mesh: keyMesh,
                    char: char,
                    baseMat: keyMesh.material,
                    pressMat: pressedMaterial,
                    isPressed: false,
                    lastPressedTime: 0
                });
            });
        });
        
        loading.style.display = 'none';
    }
    createKeyboard();

    // === ВІЗУАЛІЗАЦІЯ ПАЛЬЦІВ ===
    const fingerGeo = new THREE.SphereGeometry(0.08, 16, 16);
    const fingerMat = new THREE.MeshBasicMaterial({ color: 0xff0044 }); // Червоний
    const leftFinger = new THREE.Mesh(fingerGeo, fingerMat);
    const rightFinger = new THREE.Mesh(fingerGeo, fingerMat);
    scene.add(leftFinger);
    scene.add(rightFinger);
    leftFinger.visible = false;
    rightFinger.visible = false;

    // Анімація сцени
    function animate() {
        requestAnimationFrame(animate);
        renderer.render(scene, camera);
    }
    animate();

    // === 2. ЛОГІКА (MediaPipe) ===

    // Функція конвертації координат
    function mapTo3D(x, y) {
        // Проста проекція для стабільності
        const rangeX = 7.5; 
        const rangeY = 5.5;
        // Центруємо і масштабуємо
        return new THREE.Vector3(
            (x - 0.5) * rangeX,
            -(y - 0.5) * rangeY,
            keyboardGroup.position.z + 0.1 // Палець на рівні клавіатури
        );
    }

    function processFinger(landmarks, mesh) {
        mesh.visible = true;
        const indexTip = landmarks[8]; // Кінчик вказівного пальця
        const pos3D = mapTo3D(indexTip.x, indexTip.y);
        
        // Плавний рух (Interpolation) - щоб не тремтіло
        mesh.position.lerp(pos3D, 0.5);

        const now = Date.now();

        // Перевірка натискань
        keysData.forEach(key => {
            // Отримуємо реальну позицію клавіші у світі
            const keyPos = new THREE.Vector3();
            key.mesh.getWorldPosition(keyPos);

            // ! ВАЖЛИВО: Рахуємо тільки пласку відстань (X та Y)
            const dx = mesh.position.x - keyPos.x;
            const dy = mesh.position.y - keyPos.y;
            const distance = Math.sqrt(dx*dx + dy*dy);

            if (distance < PRESS_THRESHOLD) {
                if (!key.isPressed && (now - key.lastPressedTime > PRESS_COOLDOWN)) {
                    // НАТИСНУТО!
                    key.isPressed = true;
                    key.lastPressedTime = now;
                    key.mesh.material = key.pressMat;
                    
                    // Обробка тексту
                    if (key.char === 'DEL') {
                        typedString = typedString.slice(0, -1);
                    } else if (key.char === 'SPACE') {
                        typedString += ' ';
                    } else {
                        typedString += key.char;
                    }
                    outputText.innerText = typedString;

                    // Вібрація
                    if (navigator.vibrate) navigator.vibrate(30);

                    // Повернення кольору через 150мс
                    setTimeout(() => {
                        key.mesh.material = key.baseMat;
                        key.isPressed = false;
                    }, 150);
                }
            }
        });
    }

    function onResults(results) {
        leftFinger.visible = false;
        rightFinger.visible = false;

        if (results.multiHandLandmarks) {
            for (const landmarks of results.multiHandLandmarks) {
                // Визначаємо яка це рука (приблизно)
                // Але для клавіатури байдуже, головне активувати курсор
                if (landmarks[8].x < 0.5) { 
                    processFinger(landmarks, rightFinger); // Дзеркально
                } else {
                    processFinger(landmarks, leftFinger);
                }
            }
        }
    }

    const hands = new Hands({locateFile: (file) => {
        return `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`;
    }});
    hands.setOptions({
        maxNumHands: 2,
        modelComplexity: 1,
        minDetectionConfidence: 0.6,
        minTrackingConfidence: 0.6
    });
    hands.onResults(onResults);

    const cameraFeed = new Camera(videoElement, {
        onFrame: async () => {
            await hands.send({image: videoElement});
        },
        width: 1280, height: 720
    });
    cameraFeed.start();

    // Адаптивність
    window.addEventListener('resize', () => {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
    });

</script>
</body>
</html>
